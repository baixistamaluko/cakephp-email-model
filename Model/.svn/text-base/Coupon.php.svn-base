<?php
App::uses('AppModel', 'Model');
/**
 * Coupon Model
 *
 */
class Coupon extends AppModel {
	/**
	 * Validation rules
	 *
	 * @var array
	 */
	public $validate = array(
		'code' => array(
			'notempty' => array(
				'rule' => array('notempty'),
	//'message' => 'Your custom message here',
	//'allowEmpty' => false,
	//'required' => false,
	//'last' => false, // Stop validation after this rule
	//'on' => 'create', // Limit validation to 'create' or 'update' operations
	),
	),
		'enabled' => array(
			'boolean' => array(
				'rule' => array('boolean'),
	//'message' => 'Your custom message here',
	//'allowEmpty' => false,
	//'required' => false,
	//'last' => false, // Stop validation after this rule
	//'on' => 'create', // Limit validation to 'create' or 'update' operations
	),
	),
		'is_replace' => array(
			'boolean' => array(
				'rule' => array('boolean'),
	//'message' => 'Your custom message here',
	//'allowEmpty' => false,
	//'required' => false,
	//'last' => false, // Stop validation after this rule
	//'on' => 'create', // Limit validation to 'create' or 'update' operations
	),
	),
	);


	function getCoupon($code){
		$coupon = $this->find('first',array('conditions'=>array('code LIKE'=>$code,'enabled'=>true,
	'OR'=>array('limit_count'=>null,'limit_count >=used_count'),
	' OR'=> array('end_date>CURDATE()','end_date'=>null)
		)));

		if($coupon){ return $coupon; }
		return false;
	}

	function useCoupon($code,$coupon=null){
		if($coupon==null) { $coupon = $this->getCoupon($code); }
		if($coupon!==false){
			if($coupon['Coupon']['limit_count']!=''){
				$this->id=$coupon['Coupon']['id'];
				$this->saveField('used_count', $coupon['Coupon']['used_count']+1 );
			}
			return $coupon;
		}
		return false;
	}
}



